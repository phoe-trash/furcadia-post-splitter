os:
- linux
#- windows
#- osx
language: c
env:
- SBCL_VERSION="1.5.7"
branches:
  only:
  - master
cache:
  directories:
  - "$HOME/sbcl"
  - "$HOME/quicklisp"
  - "$HOME/.cache/common-lisp"
  - "$HOME/AppData/Local/cache/common-lisp"
install:
- SOURCE_DIR=$(pwd)
- cd ~
- if [ "$TRAVIS_OS_NAME" = "windows" -a ! -f "$HOME/sbcl/bin/sbcl" ]; then 
  SBCL_WINDOWS="http://prdownloads.sourceforge.net/sbcl/sbcl-1.4.14-x86-64-windows-binary.msi";
  wget $SBCL_WINDOWS -O sbcl.msi; 
  choco install lessmsi make;
  lessmsi x sbcl.msi $(cygpath -w "`pwd`/sbcl_ex/"); 
  mv "sbcl_ex/SourceDir/PFiles/Steel Bank Common Lisp/1.4.14" sbcl_bin;
  export SBCL_HOME="`pwd`/sbcl_bin"; 
  export PATH="`pwd`/sbcl_bin:${PATH}";
  fi
- if [ "$TRAVIS_OS_NAME" = "osx" -a ! -f "$HOME/sbcl/bin/sbcl" ]; then 
  HOMEBREW_NO_AUTO_UPDATE=1 brew install sbcl;
  fi
- if [ "$TRAVIS_OS_NAME" = "linux" -a ! -f "$HOME/sbcl/bin/sbcl" ]; then 
  sudo apt update;
  sudo apt install sbcl;
  fi
- if [ ! -f "$HOME/sbcl/bin/sbcl" ]; then 
  SBCL_SOURCE="http://downloads.sourceforge.net/project/sbcl/sbcl/$SBCL_VERSION/sbcl-$SBCL_VERSION-source.tar.bz2";
  wget $SBCL_SOURCE -O sbcl.tar.bz2;
  tar -xf sbcl.tar.bz2;
  cd "sbcl-$SBCL_VERSION";
  sh make.sh;
  unset SBCL_HOME;
  INSTALL_ROOT=~/sbcl ./install.sh;
  cd ~;
  fi
- export SBCL_HOME="$HOME/sbcl/lib/sbcl"
- export PATH="$HOME/sbcl/bin:${PATH}"
- if [ ! -f "$HOME/quicklisp/setup.lisp" ]; then
  wget https://beta.quicklisp.org/quicklisp.lisp;
  sbcl --disable-debugger 
  --eval "(load \"quicklisp.lisp\")"
  --eval "(quicklisp-quickstart:install)"
  --eval "(ql-util:without-prompting (ql:add-to-init-file))"
  --eval "(ql:update-all-dists)"
  --eval "(sb-ext:exit)";
  else
  sbcl --disable-debugger
  --eval "(load \"quicklisp/setup.lisp\")"
  --eval "(ql-util:without-prompting (ql:add-to-init-file))"
  --eval "(sb-ext:exit)";
  rm -rf ~/quicklisp/local-projects;
  mkdir ~/quicklisp/local-projects;
  fi
- if [ "$TRAVIS_OS_NAME" = "osx" ]; then
  cd ~/quicklisp/local-projects;
  wget https://github.com/Shinmera/qt-libs/archive/1b20ca0624023a1642ac94a991d4b39843e62403.zip;
  unzip 1b20ca0624023a1642ac94a991d4b39843e62403.zip;
  rm 1b20ca0624023a1642ac94a991d4b39843e62403.zip;
  mv qt-libs-1b20ca0624023a1642ac94a991d4b39843e62403 qt-libs;
  wget https://github.com/Shinmera/qtools/archive/b997b61e648f1056e35e06aa2d1af6d1b328ad0c.zip;
  unzip b997b61e648f1056e35e06aa2d1af6d1b328ad0c.zip;
  rm b997b61e648f1056e35e06aa2d1af6d1b328ad0c.zip;
  mv qtools-b997b61e648f1056e35e06aa2d1af6d1b328ad0c qtools;
  cd ~;
  fi
- mv $SOURCE_DIR ~/quicklisp/local-projects
script:
- sbcl --disable-debugger
  --eval "(ql:update-all-dists)"
  --eval "(sb-ext:exit)"
- sbcl --disable-debugger
  --eval "(ql:quickload :qtools)"
  --eval "(sb-ext:exit)"
- sbcl --disable-debugger
  --eval "(ql:quickload :qtools)"
  --eval "(ql:quickload :furcadia-post-splitter)"
  --eval "(sb-ext:exit)"
- sbcl --disable-debugger
  --eval "(asdf:make :furcadia-post-splitter)"
- mv ~/quicklisp/local-projects/furcadia-post-splitter/bin ~/bin
before_deploy:
- mv ~/bin ~/quicklisp/local-projects/furcadia-post-splitter/bin 
- cd ~/quicklisp/local-projects/furcadia-post-splitter/bin 
- zip -r "binaries-$TRAVIS_OS_NAME.zip" ~/bin
- mkdir release
- mv "binaries-$TRAVIS_OS_NAME.zip" release/
- git tag -f "nightly-${TRAVIS_COMMIT}"
deploy:
  provider: releases
  api_key:
    secure: hOB4ySsqe6Z5//kKtReEiNPweU0duWoFg6kjKyGv1uoGOdkcd7WqVWv0I4FEB9F7Kd+hP9+RYnnYiDje9aTUK67Nh/DabeGfGlHGG3BYAn3cr8GqOvfwiRYpEo6qGnu4AhnCoTO75K1318UdANill+KA5Mk1RCQyk+V4CbSUVG5xOskxJxghOzoGe16+RhInxqV4z02nRvFiqlqKYjh0Xt48rNJd3nvhgCNT3kke78Aip+Q66lKHcd74y3wifTvxJmCQrTBJazxRW14hc0OUWa9at2tRVso9urfPy2OZlJE9qxh2ms6lRbYz5H/6yyRyQc+AQ7iOguEh3OpdfnFiYNu0WTSGilgqU/0iQcyVEM5L1xkUW0pFGx2xEDVbgY3ibh3DPmtaHkDSQEIs5/pXNC9JV4vomFhP09iPnOHsky16dyfCscwZ081Fl+uEtDFG6o+vjYWb9V0aWuS9evGXA/fZoG0JKHy+GCGg4XPhBWX02TKk0NW9CE51RfcZn1z0LGpG7PX3W41SoaGHlr4FAJS2iuvCgIsLZbY9HaNEyWwGS5J/L9852JY+Ysa3dGeaOa5u+ta9mWzS0OEX4+tQG5AOnkOvPt4xBnZlF/q/IQRAb6gVQQSHY0kEBM73rW2FlC8lkoh/lCHxq/CHIgcTxlSF3P/nYlOBGzGq+UKAZKw=
  file_glob: true
  file: release/*
  on:
    repo: phoe-trash/furcadia-post-splitter
  skip_cleanup: true
  overwrite: true
