os: 
  - windows
  - linux
  - osx
language: c
env:
  - SBCL_VERSION="1.5.7"
cache:
  directories:
  - $HOME/sbcl
  - $HOME/quicklisp
  - $HOME/.cache/common-lisp
  - $HOME/AppData/Local/cache/common-lisp
install:
  - SOURCE_DIR=$(pwd)
  - rm -rf .git
  - cd ~
  # Windows - bootstrap from the public 1.4.14 binary
  - if [ "$TRAVIS_OS_NAME" = "windows" -a ! -f "$HOME/sbcl/bin/sbcl" ]; then 
    SBCL_WINDOWS="http://prdownloads.sourceforge.net/sbcl/sbcl-1.4.14-x86-64-windows-binary.msi";
    wget $SBCL_WINDOWS -O sbcl.msi; 
    choco install lessmsi make;
    lessmsi x sbcl.msi $(cygpath -w "`pwd`/sbcl_ex/");
    mv "sbcl_ex/SourceDir/PFiles/Steel Bank Common Lisp/1.4.14" sbcl_bin;
    export SBCL_HOME="`pwd`/sbcl_bin";
    export PATH="`pwd`/sbcl_bin:${PATH}";
    fi
  # macOS - use homebrew
  - if [ "$TRAVIS_OS_NAME" = "osx" -a ! -f "$HOME/sbcl/bin/sbcl" ]; then 
    HOMEBREW_NO_AUTO_UPDATE=1 brew install sbcl;
    fi
  # Linux - use apt
  - if [ "$TRAVIS_OS_NAME" = "linux" -a ! -f "$HOME/sbcl/bin/sbcl" ]; then 
    sudo apt update; 
    sudo apt install sbcl; 
    fi
  # Build new SBCL from source
  - if [ ! -f "$HOME/sbcl/bin/sbcl" ]; then 
    SBCL_SOURCE="http://downloads.sourceforge.net/project/sbcl/sbcl/$SBCL_VERSION/sbcl-$SBCL_VERSION-source.tar.bz2";
    wget $SBCL_SOURCE -O sbcl.tar.bz2;
    tar -xf sbcl.tar.bz2;
    cd "sbcl-$SBCL_VERSION";
    sh make.sh;
    unset SBCL_HOME;
    INSTALL_ROOT=~/sbcl ./install.sh;
    cd ~;
    fi
  # Set paths
  - export SBCL_HOME="$HOME/sbcl/lib/sbcl"
  - export PATH="$HOME/sbcl/bin:${PATH}"
  # Install Quicklisp
  - if [ ! -f "$HOME/quicklisp/setup.lisp" ]; then 
    wget https://beta.quicklisp.org/quicklisp.lisp;
    sbcl --disable-debugger
    --eval "(load \"quicklisp.lisp\")" 
    --eval "(quicklisp-quickstart:install)"
    --eval "(ql-util:without-prompting (ql:add-to-init-file))"
    --eval "(ql:update-all-dists)"
    --eval "(sb-ext:exit)";
    else
    sbcl --disable-debugger
    --eval "(load \"quicklisp/setup.lisp\")" 
    --eval "(ql-util:without-prompting (ql:add-to-init-file))"
    --eval "(sb-ext:exit)";
    rm -rf ~/quicklisp/local-projects;
    mkdir ~/quicklisp/local-projects;
    fi
  # Work around macOS qt-libs path issue
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then 
    cd ~/quicklisp/local-projects/qt-libs;
    wget https://github.com/Shinmera/qt-libs/archive/1b20ca0624023a1642ac94a991d4b39843e62403.zip;
    unzip 1b20ca0624023a1642ac94a991d4b39843e62403.zip;
    rm 1b20ca0624023a1642ac94a991d4b39843e62403.zip;
    mv qt-libs-1b20ca0624023a1642ac94a991d4b39843e62403 qt-libs;
    cd ~;
    fi
  # Copy the library into local-projects
  - mv $SOURCE_DIR ~/quicklisp/local-projects
script:
  - sbcl --disable-debugger
    --eval "(ql:update-all-dists)"
    --eval "(sb-ext:exit)"
  - sbcl --disable-debugger
    --eval "(ql:quickload :qtools)"
    --eval "(sb-ext:exit)"
  - sbcl --disable-debugger
    --eval "(ql:quickload :qtools)"
    --eval "(ql:quickload :furcadia-post-splitter)"
    --eval "(sb-ext:exit)"
  - sbcl --disable-debugger
    --eval "(asdf:make :furcadia-post-splitter)"
  - mv ~/quicklisp/local-projects/furcadia-post-splitter/bin ~/binaries
